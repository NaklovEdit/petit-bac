<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Petit Bac Online - Score Auto</title>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>

    <style>
        :root { --primary: #3f51b5; --danger: #f44336; --success: #4caf50; }
        body { font-family: 'Segoe UI', sans-serif; background: #f0f2f5; display: flex; flex-direction: column; align-items: center; padding: 10px; margin: 0; color: #333; }
        h1 { margin-bottom: 10px; }
        #app-container { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); width: 100%; max-width: 95%; }
        
        #login-screen { text-align: center; padding: 30px; }
        #login-screen input { padding: 10px; margin: 5px; font-size: 16px; border: 2px solid #ddd; border-radius: 5px; }
        
        .status-bar { display: flex; justify-content: space-between; background: #e3f2fd; padding: 15px; border-radius: 8px; margin-bottom: 20px; font-weight: bold; font-size: 1.1em; }
        .letter-box { color: var(--danger); font-size: 1.4em; }
        #timer-box { color: var(--primary); }
        .game-status-msg { text-align: center; margin-bottom: 15px; font-style: italic; color: #666; }

        #game-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 15px; margin-bottom: 25px; }
        .input-group { display: flex; flex-direction: column; }
        .input-group label { margin-bottom: 5px; font-weight: 600; color: #555; font-size: 0.9em; }
        .input-group input { padding: 10px; border: 2px solid #ddd; border-radius: 5px; font-size: 16px; transition: border-color 0.3s; }
        .input-group input:focus { border-color: var(--primary); outline: none; }
        .input-group input:disabled { background-color: #eee; color: #777; cursor: not-allowed; }

        .controls { display: flex; justify-content: center; gap: 15px; margin-bottom: 20px; }
        button { padding: 12px 30px; font-size: 16px; border: none; border-radius: 50px; color: white; font-weight: bold; cursor: pointer; transition: transform 0.1s, opacity 0.2s;box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
        button:active { transform: scale(0.98); }
        button:disabled { opacity: 0.5; cursor: not-allowed; }
        .btn-start { background-color: var(--success); }
        .btn-stop { background-color: var(--danger); }
        .btn-join { background-color: var(--primary); }

        #results-area { margin-top: 30px; border-top: 2px solid #eee; padding-top: 20px; }
        .table-wrapper { overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; margin-top: 15px; font-size: 0.9em; min-width: 600px; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        th { background-color: #f8f9fa; position: sticky; left: 0; }
        td.player-name { font-weight: bold; color: var(--primary); background: #fdfdfd; }
        
        .score-pill { display: inline-block; background: #333; color: #fff; padding: 2px 6px; border-radius: 10px; font-size: 0.8em; margin-left: 5px; }
        .invalid-word { text-decoration: line-through; color: #999; }
        .total-cell { font-weight: bold; font-size: 1.1em; color: var(--success); }

        .hidden { display: none !important; }
    </style>
</head>
<body>

    <h1>Petit Bac Pro</h1>

    <div id="app-container">
        <div id="login-screen">
            <h2>Rejoindre une partie</h2>
            <input type="text" id="room-code" placeholder="Code de la salle (ex: TEAM1)" autocomplete="off">
            <br>
            <input type="text" id="username" placeholder="Votre Pseudo">
            <br><br>
            <button class="btn-join" onclick="joinRoom()">REJOINDRE</button>
        </div>

        <div id="game-screen" class="hidden">
            <div class="status-bar">
                <div>Salle: <span id="room-display"></span> | Joueur: <span id="player-display"></span></div>
                <div id="players-list">...</div>
            </div>

            <div class="status-bar main-status">
                <div>Lettre : <span id="lettre-display" class="letter-box">?</span></div>
                <div>Temps : <span id="timer-display" class="timer-box">60</span>s</div>
            </div>

            <div id="status-message" class="game-status-msg">En attente...</div>

            <div id="game-grid"></div>

            <div class="controls">
                <button id="btn-start" class="btn-start" onclick="startGameCmd()">LANCER MANCHE</button>
                <button id="btn-stop" class="btn-stop" onclick="stopGameCmd()" disabled>STOP !</button>
            </div>

            <div id="results-area" class="hidden">
                <h2>Résultats et Scores</h2>
                <p id="stopper-info"></p>
                <div class="table-wrapper">
                    <table id="results-table"></table>
                </div>
            </div>
        </div>
    </div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyBqy4pRUhq4XLv5rUxlcsOLY_TgzuIvQWk",
            authDomain: "petit-bac-fc0f6.firebaseapp.com",
            databaseURL: "https://petit-bac-fc0f6-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "petit-bac-fc0f6",
            storageBucket: "petit-bac-fc0f6.firebasestorage.app",
            messagingSenderId: "838878170684",
            appId: "1:838878170684:web:d7670d939a3ac75870fd39",
            measurementId: "G-WW8GENYGZX"
        };
        
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        const categories = ["Prénom", "Pays", "Ville", "Marque", "Objet", "Animal", "Acteurs", "Fruit/Légume", "Métier", "Personnages"];
        let currentRoomId = null;
        let myUserId = null;
        let myUsername = null;
        let localTimerInt = null;
        let isHost = false;
        let currentLetterGlobal = "";

        const sounds = {
            start: new Audio('https://assets.mixkit.co/sfx/preview/mixkit-game-level-music-689.mp3'),
            stop: new Audio('https://assets.mixkit.co/sfx/preview/mixkit-arcade-retro-game-over-213.mp3')
        };

        function generateGrid() {
            const grid = document.getElementById('game-grid');
            grid.innerHTML = '';
            categories.forEach((cat, idx) => {
                grid.innerHTML += `
                    <div class="input-group">
                        <label>${cat}</label>
                        <input type="text" id="input-${idx}" class="game-input" disabled autocomplete="off">
                    </div>`;
            });
        }

        function joinRoom() {
            const roomCodeInput = document.getElementById('room-code').value.toUpperCase().trim();
            const usernameInput = document.getElementById('username').value.trim();

            if (!roomCodeInput || !usernameInput) { alert("Code et Pseudo requis"); return; }

            currentRoomId = "room_" + roomCodeInput;
            myUsername = usernameInput;
            myUserId = 'user_' + Math.random().toString(36).substr(2, 9);

            document.getElementById('login-screen').classList.add('hidden');
            document.getElementById('game-screen').classList.remove('hidden');
            document.getElementById('room-display').innerText = roomCodeInput;
            document.getElementById('player-display').innerText = myUsername;

            generateGrid();
            setupFirebaseListeners();

            db.ref(currentRoomId + '/players/' + myUserId).set({
                name: myUsername
            });
            db.ref(currentRoomId + '/players/' + myUserId).onDisconnect().remove();
        }

        function setupFirebaseListeners() {
            const roomRef = db.ref(currentRoomId);

            roomRef.child('players').on('value', snapshot => {
                const players = snapshot.val();
                if (!players) return;
                const names = Object.values(players).map(p => p.name).join(', ');
                document.getElementById('players-list').innerText = names;
                isHost = (Object.keys(players)[0] === myUserId);
                
                if(document.getElementById('results-area').classList.contains('hidden') === false) {
                    renderResultsTable(players);
                }
            });

            roomRef.child('gameState').on('value', snapshot => {
                handleGameStateChange(snapshot.val());
            });

             roomRef.child('currentLetter').on('value', snap => {
                 currentLetterGlobal = snap.val() || "?";
                 document.getElementById('lettre-display').innerText = currentLetterGlobal;
             });

             roomRef.child('stopperName').on('value', snap => {
                 const name = snap.val();
                 if(name) document.getElementById('stopper-info').innerText = `STOP par : ${name}`;
             });
        }

        function handleGameStateChange(state) {
            clearInterval(localTimerInt);
            const inputs = document.querySelectorAll('.game-input');
            const btnStop = document.getElementById('btn-stop');
            const btnStart = document.getElementById('btn-start');
            const resultsArea = document.getElementById('results-area');

            if (state === 'playing') {
                resultsArea.classList.add('hidden');
                btnStop.disabled = false;
                btnStart.disabled = true;
                inputs.forEach(i => { i.disabled = false; i.value = ''; });
                inputs[0].focus();
                syncTimer();
                sounds.start.play().catch(()=>{});
            } else if (state === 'finished') {
                resultsArea.classList.remove('hidden');
                btnStop.disabled = true;
                btnStart.disabled = false;
                inputs.forEach(i => i.disabled = true);
                submitMyAnswers();
                sounds.stop.play().catch(()=>{});
            } else {
                resultsArea.classList.add('hidden');
                btnStop.disabled = true;
                btnStart.disabled = false;
                inputs.forEach(i => { i.disabled = true; i.value = '';});
                document.getElementById('timer-display').innerText = "60";
            }
        }

        function startGameCmd() {
            db.ref(currentRoomId + '/players').once('value', snap => {
                snap.forEach(playerSnap => {
                    playerSnap.ref.child('answers').remove();
                });
            });

            const alphabet = "ABCDEFGHIJKLMNOPQRSTUVWXYZ";
            const lettre = alphabet[Math.floor(Math.random() * alphabet.length)];
            
            db.ref(currentRoomId).update({
                gameState: 'playing',
                currentLetter: lettre,
                startTime: firebase.database.ServerValue.TIMESTAMP,
                stopperName: null
            });
        }

        function stopGameCmd() {
            db.ref(currentRoomId).update({
                gameState: 'finished',
                stopperName: myUsername
            });
        }

        function submitMyAnswers() {
            const myAnswers = [];
            const inputs = document.querySelectorAll('.game-input');
            inputs.forEach(input => {
                 myAnswers.push(input.value.trim());
            });
            db.ref(currentRoomId + '/players/' + myUserId + '/answers').set(myAnswers);
        }

        function syncTimer() {
            db.ref(currentRoomId + '/startTime').once('value', snap => {
                const startTimestamp = snap.val();
                if (!startTimestamp) return;

                localTimerInt = setInterval(() => {
                    const elapsedSec = Math.floor((Date.now() - startTimestamp) / 1000);
                    const remaining = 60 - elapsedSec;

                    if (remaining <= 0) {
                        document.getElementById('timer-display').innerText = "0";
                        clearInterval(localTimerInt);
                        if (isHost && document.getElementById('btn-stop').disabled === false) {
                             db.ref(currentRoomId).update({ gameState: 'finished', stopperName: "Temps Écoulé" });
                        }
                    } else {
                        document.getElementById('timer-display').innerText = remaining;
                    }
                }, 1000);
            });
        }

        function renderResultsTable(playersData) {
            const table = document.getElementById('results-table');
            let headerHTML = '<thead><tr><th>Joueur</th>';
            categories.forEach(cat => headerHTML += `<th>${cat}</th>`);
            headerHTML += '<th>TOTAL</th></tr></thead><tbody id="results-body">';
            
            const playerIds = Object.keys(playersData);
            const scores = {};
            playerIds.forEach(id => scores[id] = 0);

            const displayMatrix = {}; 

            for (let i = 0; i < categories.length; i++) {
                const answersInCat = {};
                
                playerIds.forEach(pid => {
                    const ans = (playersData[pid].answers && playersData[pid].answers[i]) ? playersData[pid].answers[i] : "";
                    const cleanAns = ans.trim().toUpperCase();
                    
                    if (cleanAns.length > 0 && cleanAns.startsWith(currentLetterGlobal)) {
                        if (!answersInCat[cleanAns]) answersInCat[cleanAns] = 0;
                        answersInCat[cleanAns]++;
                    }
                });

                playerIds.forEach(pid => {
                    const rawAns = (playersData[pid].answers && playersData[pid].answers[i]) ? playersData[pid].answers[i] : "";
                    const cleanAns = rawAns.trim().toUpperCase();
                    let pts = 0;
                    let isValid = false;

                    if (cleanAns.length > 0) {
                        if (!cleanAns.startsWith(currentLetterGlobal)) {
                            isValid = false; 
                        } else {
                            isValid = true;
                            const count = answersInCat[cleanAns];
                            pts = 2 / count;
                        }
                    }

                    scores[pid] += pts;
                    
                    if (!displayMatrix[pid]) displayMatrix[pid] = [];
                    
                    let cellClass = isValid ? "" : (cleanAns.length > 0 ? "invalid-word" : "");
                    let ptsDisplay = (pts > 0) ? `<span class="score-pill">+${parseFloat(pts.toFixed(2))}</span>` : "";
                    
                    displayMatrix[pid].push({
                        word: rawAns,
                        html: `<span class="${cellClass}">${rawAns || "-"}</span>${ptsDisplay}`
                    });
                });
            }

            let bodyHTML = "";
            playerIds.forEach(pid => {
                bodyHTML += `<tr><td class="player-name">${playersData[pid].name}</td>`;
                displayMatrix[pid].forEach(item => {
                    bodyHTML += `<td>${item.html}</td>`;
                });
                bodyHTML += `<td class="total-cell">${parseFloat(scores[pid].toFixed(2))}</td></tr>`;
            });
            
            table.innerHTML = headerHTML + bodyHTML + "</tbody>";
        }

        window.addEventListener('beforeunload', function () {
            if (myUserId && currentRoomId) {
                db.ref(currentRoomId + '/players/' + myUserId).remove();
            }
        });
    </script>
</body>
</html>
